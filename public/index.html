<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Welcome!</title>
    <script src="https://unpkg.com/vue@next"></script>
    <script src="/site/protobuf-light.js"></script>

    <style>
      .base-btn {
        color: #fff;
        background-color: #409eff;
        width: 176px;
        height: 40px;
        font-size: 16px;
        font-weight: 400;
        border-radius: 6px;
        box-sizing: border-box;
        outline: 0;
        white-space: nowrap;
        cursor: pointer;
        border: 1px solid #409eff;
      }
    </style>
  </head>
  <body>
    <h2>Welcome index</h2>
    <div class="protobuf"></div>
    <button class="base-btn" onclick="deal()">use protobuf</button>

    <div id="app"></div>

    <script>
      let $root = undefined

      async function main() {
        const json = await fetch(`http://localhost:3888/site/proto.json`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json"
          }
        }).then(res => res.json())

        if (protobuf && protobuf.roots) {
          $root = protobuf.roots["default"] = new protobuf.Root()
          $root.addJSON(json.nested)

          const PBMessageResponse = $root.lookup("ns.AwesomeMessage")
          console.log(PBMessageResponse)
          const buffer = await fetch(`http://localhost:3888/proto/encode`, {
            method: "GET",
            headers: {
              "Content-Type": "application/x-protobuf",
              Accept: "application/x-protobuf"
            }
          }).then(res => res.arrayBuffer())

          const buf = protobuf.util.newBuffer(buffer)
          if (!PBMessageResponse) {
            throw new Error(`Not parse with $root.lookup`)
            return
          }
          // decode响应体
          const decodedResponse = PBMessageResponse.decode(buf)
          console.log(`decode success: 👇🏻👇🏻👇🏻 \n`, decodedResponse)
          document.querySelector("div.protobuf").innerHTML = JSON.stringify(decodedResponse.toJSON(), null, 2)
        }
      }

      function deal() {
        main()
      }
      const { createApp, h, ref, unref } = Vue
      const app = Vue.createApp({
        setup() {
          const count = ref(4)
          return () => {
            return h("div", {}, unref(count))
          }
        }
      })
      const vm = app.mount("#app")
    </script>
  </body>
</html>
